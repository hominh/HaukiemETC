$(document).ready(function(){var b,c,d,a,e,g="";function f(){var b=0,f="";$("input:checkbox[name=tickettype]").each(function(){$(this).is(":checked")&&(""!=f&&(f+=","),f+=$(this).val())});var c=0;$("#freec").is(":checked")&&(c=1);var d=0;$("#freedc").is(":checked")&&(d=1);var a=3;($("#etcday").is(":checked")||$("#etcmonth").is(":checked")||$("#etcmpkv").is(":checked")||$("#etcmienphi").is(":checked")||$("#etcoffline").is(":checked"))&&($("#nomoney").is(":checked")&& !1==$("#hasmoney").is(":checked")&&(a=0),$("#hasmoney").is(":checked")&& !1==$("#nomoney").is(":checked")&&(a=1),$("#hasmoney").is(":checked")&&$("#nomoney").is(":checked")&&(a=3),!1==$("#hasmoney").is(":checked")&& !1==$("#nomoney").is(":checked")&&(a=3),0==$("select[name=tickettypevetc]").val()&&(b=0),1==$("select[name=tickettypevetc]").val()&&(b=1),2==$("select[name=tickettypevetc]").val()&&(b=5)),e=$("#listSoatve").DataTable({destroy:!0,bInfo:!1,bLengthChange:!1,searching:!1,paging:!0,pageLength:8,processing:!0,serverSide:!0,autoWidth:!1,keys:!0,select:!0,order:[[1,"desc"]],columnDefs:[{visible:!1,targets:[11,12,13]}],ajax:{url:url_listsoatve,type:"POST",data:{timestart:$("input[name=timestart]").val(),timeend:$("input[name=timeend]").val(),plate:$("input[name=plate]").val(),barcode:$("input[name=barcode]").val(),employee:$("select[name=employee]").val(),lane:$("select[name=lane]").val(),cartype:$("select[name=cartype]").val(),platetype:$("select[name=platetype]").val(),transactiontype:$("select[name=transactiontype]").val(),tickettype:f,freec:c,freedc:d,isMoney:a,tickettypevetc:b}},fnRowCallback:function(c,a,d,e){var b="";null!=a[4]?("T"==a[4].substr(a[4].length-1)||"V"==a[4].substr(a[4].length-1)||"X"==a[4].substr(a[4].length-1))&&(b=a[4].substring(0,a[4].length-1)):b=a[4],null!=a[6]&&(""==a[3]||a[3]!=b)&&$("td",c).css("background-color","Yellow")},initComplete:function(){$("#listSoatve tr td").length>1&&$("#listSoatve").find("tbody tr:eq(0)").trigger("click")}})}function h(a){$("#plate_old").val(),$("#image_lane").attr("src",a[11]),$("#image_bienso").attr("src",a[12]),$("#changetransaction_plate").val(a[3]),$("#changetransaction_etag").val(a[13]),$("#changetransaction_ticketid").val(a[5]),$("#changetransaction_type").val(a[6]),$("#soatve_id").val(a[0]),$("#plate_old").val(a[3]),g=a[1],"Commit"==a[6]?$("#commitbutton").prop("disabled",!0):$("#commitbutton").prop("disabled",!1),(""==a[5]||""==a[13]|| -1!=a[7].indexOf("MTC"))&&($("#commitbutton").prop("disabled",!0),$("#lockbutton").prop("disabled",!0)),$.ajax({type:"POST",url:url_getvehiclebyplate,data:{plate:a[3]},success:function(a){(a=JSON.parse(a)).length>0?($("#trueplate").val(a[0].xe_bienso),$("#employeesavetruevehicle").val(a[0].nsd_ten),$("#datesavetruevehicle").val(a[0].xe_ngaynhap),$("#truevehicletype").val(a[0].xe_loaixe),$("#notetruevehicle").val(a[0].xe_ghichu),1==a[0].xe_canhbao?$("#isWarning").attr("checked","checked"):$("#isWarning").removeAttr("checked")):($("#trueplate").val(""),$("#employeesavetruevehicle").val(""),$("#datesavetruevehicle").val(""),$("#notetruevehicle").val(""),$("#truevehicletype").val(0),$("#isWarning").removeAttr("checked"))}}),$("#listHistory").DataTable({destroy:!0,bInfo:!0,bLengthChange:!1,searching:!1,paging:!1,processing:!0,serverSide:!0,autoWidth:!1,selected:!0,page:"current",ajax:{url:url_getListByPlate,type:"POST",data:{plate:a[3]}}})}function i(){$("#listVideo").DataTable({destroy:!0,bInfo:!1,bLengthChange:!1,searching:!1,paging:!0,pageLength:18,processing:!0,serverSide:!0,autoWidth:!1,order:[[2,"desc"]],columnDefs:[{visible:!1,targets:[3]}],ajax:{url:url_videofilter,type:"POST",data:{fromtime:$("#timestartVideo").val(),totime:$("#timeendVideo").val(),camera:$("select[name=camera]").val()}}})}c=(b=new Date).getMonth()+1,d=b.getDate(),a=b.getFullYear()+"-"+(c<10?"0":"")+c+"-"+(d<10?"0":"")+d,$("#timestart").val(a+" 00:00:00"),$("#timeend").val(a+" 23:59:59"),$("#timestartVideo").val(a+" 00:00:00"),$("#timeendVideo").val(a+" 23:59:59"),$(".form_datetime").datetimepicker({weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,showMeridian:1}),f(),$("#listSoatve tbody").on("click","tr",function(){var b=$(this).closest("tr"),a=e.row(b).data();console.log(a),h(a)}),e.on("key-focus",function(c,d,a,b){"keydown"===b.type&&(e.rows().deselect(),e.row(a[0][0].row).select(),h(e.row(a[0][0].row).data()))}),$("#timestartVideo").change(function(){i()}),$("#timeendVideo").change(function(){i()}),$("#camera").on("change",function(a){i()}),$("#btnSearch").click(function(a){f()}),$("#btnUpdateTrueVehicle").click(function(b){var a=0;if(""==$("#trueplate").val()){toastr.error("C\u1EA7n nh\u1EADp bi\u1EC3n s\u1ED1");return}$("#isWarning").is(":checked")&&(a=1),b.preventDefault(),$.ajax({type:"POST",url:url_vehicleupdate,data:{xe_bienso:$("#trueplate").val(),xe_loaixe:$("#truevehicletype").val(),xe_canhbao:a,xe_ghichu:$("#notetruevehicle").val()},success:function(a){"1"==a?toastr.info("C\u1EADp nh\u1EADt xe chu\u1EA9n th\xe0nh c\xf4ng"):toastr.error("C\u1EADp nh\u1EADt xe chu\u1EA9n th\u1EA5t b\u1EA1i")}})}),$("#commitbutton").click(function(a){a.preventDefault(),$.ajax({type:"POST",url:url_changecommittype,data:{vetctransaction_ticketid:$("#changetransaction_ticketid").val()},success:function(a){"1"==a?toastr.info("Chuy\u1EC3n \u0111\u1ED5i giao d\u1ECBch th\xe0nh c\xf4ng"):toastr.error("Chuy\u1EC3n \u0111\u1ED5i giao d\u1ECBch th\u1EA5t b\u1EA1i")}}),f()}),$("#lockbutton").click(function(a){a.preventDefault(),$.ajax({type:"POST",url:url_locktransaction,data:{vetctransaction_ticketid:$("#changetransaction_ticketid").val()},success:function(a){"1"==a?toastr.info("Kh\xf3a giao d\u1ECBch th\xe0nh c\xf4ng"):toastr.error("Kh\xf3a giao d\u1ECBch th\u1EA5t b\u1EA1i")}}),f()}),$("#btnUpdatePlate").click(function(a){a.preventDefault(),$.ajax({type:"POST",url:url_updateplate,data:{soatve_id:$("#soatve_id").val(),plate:$("#plate").val(),plate_old:$("#plate_old").val()},success:function(a){"1"==a?toastr.info("C\u1EADp nh\u1EADt bi\u1EC3n s\u1ED1 th\xe0nh c\xf4ng"):toastr.error("C\u1EADp nh\u1EADt bi\u1EC3n s\u1ED1 th\u1EA5t b\u1EA1i")}}),$("#plate").val(""),f()}),$("#btnExport").click(function(f){$(".dataTables_processing").hide(),$(".dataTables_processing").show();var b=0,e="";$("input:checkbox[name=tickettype]").each(function(){$(this).is(":checked")&&(""!=e&&(e+=","),e+=$(this).val())});var c=0;$("#freec").is(":checked")&&(c=1);var d=0;$("#freedc").is(":checked")&&(d=1);var a=3;($("#etcday").is(":checked")||$("#etcmonth").is(":checked")||$("#etcmpkv").is(":checked")||$("#etcmienphi").is(":checked")||$("#etcoffline").is(":checked"))&&($("#nomoney").is(":checked")&& !1==$("#hasmoney").is(":checked")&&(a=0),$("#hasmoney").is(":checked")&& !1==$("#nomoney").is(":checked")&&(a=1),$("#hasmoney").is(":checked")&&$("#nomoney").is(":checked")&&(a=3),!1==$("#hasmoney").is(":checked")&& !1==$("#nomoney").is(":checked")&&(a=3),0==$("select[name=tickettypevetc]").val()&&(b=0),1==$("select[name=tickettypevetc]").val()&&(b=1),2==$("select[name=tickettypevetc]").val()&&(b=5)),$.ajax({type:"POST",url:url_export_excel,data:{timestart:$("input[name=timestart]").val(),timeend:$("input[name=timeend]").val(),plate:$("input[name=plate]").val(),barcode:$("input[name=barcode]").val(),employee:$("select[name=employee]").val(),lane:$("select[name=lane]").val(),cartype:$("select[name=cartype]").val(),platetype:$("select[name=platetype]").val(),transactiontype:$("select[name=transactiontype]").val(),tickettype:e,freec:c,freedc:d,isMoney:a,tickettypevetc:b},success:function(b){var a=$("<a>");a.attr("href",JSON.parse(b).file),$("body").append(a),a.attr("download",JSON.parse(b).filename),a[0].click(),a.remove(),$(".dataTables_processing").hide(),toastr.info("Download file complete")}})});var j=indexUpSpeed=parseFloat(2),k=1,l=0;function m(){var a="tbody tr:eq(";a+=parseInt(l)+1,a+=")",$("#listVideo").find(a).trigger("click")}$("#btnPlayback").click(function(d){var a,b,c;$("#modalPlayback").modal("show"),a=parseInt(a),b=parseInt(b),c=parseInt(c),$("#time").html(a+":"+b+":"+c),j=indexUpSpeed=parseFloat(2),k=1,$("#listVideo").DataTable({destroy:!0,bInfo:!1,bLengthChange:!1,searching:!1,paging:!0,pageLength:18,processing:!0,serverSide:!0,autoWidth:!1,order:[[2,"desc"]],columnDefs:[{visible:!1,targets:[3]}],ajax:{url:url_getlistvideobytime,type:"POST",data:{video_thoigian:g}},initComplete:function(){$("#listVideo tr td").length>1&&$("#listVideo").find("tbody tr:eq(0)").trigger("click")}})}),$("body").on("click","#listVideo tr",function(){$("#listVideo tbody tr").removeClass("row_selected"),$(this).addClass("row_selected");var a=$(this).closest("tr");l=a.index();var b=$("#listVideo").DataTable().row(a).data();$("#videoView").attr("src",b[3]),$("#videoView")[0].load()}),$("#playVideo").click(function(a){$("#videoView").trigger("play"),$(this).prop("disabled",!0)}),$("#pauseVideo").click(function(a){$("#videoView").trigger("pause"),$("#playVideo").prop("disabled",!1)}),$("#nextVideo").click(function(a){m()}),$("#prevVideo").click(function(b){var a="tbody tr:eq(";a+=parseInt(l)-1,a+=")",$("#listVideo").find(a).trigger("click")}),$("#speedDownVideo").click(function(a){(k=parseFloat(k/j))<=parseFloat(.03125)&&(k=parseFloat(.03125)),document.querySelector("video").playbackRate=parseFloat(k)}),$("#speedUpVideo").click(function(a){(k=parseFloat(k*indexUpSpeed))>=32&&(k=16),document.querySelector("video").playbackRate=parseFloat(k)}),$("#videoView").on("ended",function(){$("#isNextVideo").is(":checked")&&m()})})